## Iframe Page

App iframe pages allow developers to create custom interfaces that are embedded directly within the Booqable UI. This provides a seamless user experience where app functionality feels like a native part of the Booqable platform, while allowing developers to build rich, interactive interfaces using their own technology stack.

Iframe pages are particularly useful for apps that need:

* Custom control surfaces and dashboards
* Complex configuration interfaces with custom validation
* Interactive setup wizards and onboarding flows
* Custom data visualization and monitoring

### How iframe pages work

When an app is configured to use an iframe page, Booqable embeds the app's interface within an iframe element in the admin dashboard. The iframe loads content from the app's specified URL, which can be either:

* A relative path that gets prefixed with the app's base URL
* An absolute URL pointing to the app's interface

The iframe is automatically sized to fit the content and provides a secure communication channel between the app and Booqable through the postMessage API. This allows apps to create dedicated pages within the Booqable dashboard for their specific functionality.

```json
{
  "base_url": {
    "production": "https://my-app.com"
  },
  "ui_extension": {
    "frames": {
      "app_config": "/admin/apps/my-app/config"
    }
  }
}
```
```json
{
  "ui_extension": {
    "frames": {
      "app_config": "https://external-service.com/booqable/config"
    }
  }
}
```

Iframe pages are configured in your app's `meta.json` file using the [`ui_extension.frames` property](#reference-framesettings). When a frame is accessed, Booqable automatically appends authentication and context parameters to the URL, including the JWT token and locale information.

### Authentication token

The iframe URL includes a JWT token as a query parameter that provides authentication and context information. This token contains:

* **Company ID** - The ID of the company using the app.
* **Company Slug** - The unique identifier for the company.
* **User Email** - The email of the current employee.
* **Currency Settings** - The company's currency configuration.
* **Distance Unit** - The company's preferred distance unit for deliveries.

The token is automatically generated by Booqable and passed to the iframe URL. Apps should validate this token to ensure requests are coming from legitimate Booqable instances.

### Message protocol

The iframe and Booqable communicate through a standardized postMessage protocol. All messages follow this structure:

```javascript
{
  eventName: "MESSAGE_TYPE",
  payload: {
    // Message-specific data
  }
}
```

#### Messages from iframe to Booqable

**SET_IFRAME_HEIGHT**
Adjusts the iframe height to fit the content.

```javascript
window.parent.postMessage({
  eventName: "SET_IFRAME_HEIGHT",
  payload: {
    height: 600
  }
}, "*")
```

**SET_FLASH_MESSAGE**
Displays a success or error message to the user.

```javascript
window.parent.postMessage({
  eventName: "SET_FLASH_MESSAGE",
  payload: {
    type: "success", // or "error"
    action: "saved", // or "created", "updated", "deleted"
    resource: "settings",
    actioned: "configuration"
  }
}, "*")
```

**REFRESH_SUBSCRIPTION**
Requests Booqable to refresh the app subscription data.

```javascript
window.parent.postMessage({
  eventName: "REFRESH_SUBSCRIPTION",
  payload: {}
}, "*")
```

**GET_AVATAR**
Requests user avatar information for display in the iframe.

```javascript
window.parent.postMessage({
  eventName: "GET_AVATAR",
  payload: {
    id: "user_id",
    name: "User Name"
  }
}, "*")
```

**NAVIGATE**
Requests Booqable to navigate to a different page.

```javascript
window.parent.postMessage({
  eventName: "NAVIGATE",
  payload: {
    url: "/app-store/my-app/settings"
  }
}, "*")
```

#### Messages from Booqable to iframe

**SET_AVATAR**
Provides avatar information in response to a GET_AVATAR request.

```javascript
// Sent by Booqable to the iframe
{
  eventName: "SET_AVATAR",
  payload: {
    avatar: {
      id: "user_id",
      color: "#FF5733",
      initials: "UN",
      initialsColor: "#FFFFFF"
    }
  }
}
```

### Implementation example

To the right is an example of a configuration interface.

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>App Configuration</title>
</head>
<body>
  <h1>Configure Your App</h1>
  <form id="settings-form">
    <label for="api_key">API Key</label>
    <input type="password" id="api_key" name="api_key" required>
    <div id="api_key_error" style="display: none; color: red;"></div>

    <button type="submit">Save Configuration</button>
  </form>

  <script>
    // Security: Validate message origin
    const ALLOWED_ORIGINS = ['booqable.com'];

    function isValidOrigin(origin) {
      try {
        const hostname = new URL(origin).hostname;
        return ALLOWED_ORIGINS.some(allowed => hostname.endsWith(allowed));
      } catch {
        return false;
      }
    }

    function showError(fieldId, message) {
      document.getElementById(fieldId + '_error').textContent = message;
      document.getElementById(fieldId + '_error').style.display = 'block';
    }

    function adjustHeight() {
      window.parent.postMessage({
        eventName: 'SET_IFRAME_HEIGHT',
        payload: { height: document.body.scrollHeight }
      }, '*');
    }

    // Listen for messages from Booqable
    window.addEventListener('message', function(event) {
      if (!isValidOrigin(event.origin)) {
        console.warn('Unauthorized origin:', event.origin);
        return;
      }

      if (event.data.eventName === 'SET_AVATAR') {
        console.log('Received avatar:', event.data.payload.avatar);
      }
    });

    // Handle form submission
    document.getElementById('settings-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const apiKey = document.getElementById('api_key').value.trim();
      if (!apiKey) {
        showError('api_key', 'API key is required');
        return;
      }

      // Save configuration (replace with actual API call)
      setTimeout(() => {
        // Notify Booqable of success
        window.parent.postMessage({
          eventName: 'SET_FLASH_MESSAGE',
          payload: {
            type: 'success',
            action: 'saved',
            resource: 'settings',
            actioned: 'configuration'
          }
        }, '*');

        window.parent.postMessage({
          eventName: 'REFRESH_SUBSCRIPTION',
          payload: {}
        }, '*');
      }, 1000);
    });

    // Adjust height on load
    window.addEventListener('load', adjustHeight);
  </script>
</body>
</html>
```
